// Tratamento para requisições OPTIONS (CORS preflight)
function doOptions(e) {
  return ContentService.createTextOutput("")
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*")
    .setHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS")
    .setHeader("Access-Control-Allow-Headers", "Content-Type");
}
const SS = SpreadsheetApp.getActiveSpreadsheet();

function doGet(e) {
  const action = e.parameter.action;
  if (action === "getAlunos") {
    const dados = SS.getSheetByName("Alunos").getDataRange().getValues();
    return response(dados.filter(r => r[1] === e.parameter.serie).map(r => ({nome: r[0], eletiva: r[2]})));
  }
  if (action === "getEletivas") {
    const elts = SS.getSheetByName("Config_Eletivas").getDataRange().getValues();
    const alns = SS.getSheetByName("Alunos").getDataRange().getValues();
    return response(elts.slice(1).map(r => ({
      nome: r[0], descricao: r[1], professor: r[2], vagasTotais: r[3], foto: r[4],
      vagasRestantes: r[3] - alns.filter(a => a[2] === r[0]).length
    })));
  }
  if (action === "getInscritosPorEletiva") {
  const eletivaNome = e.parameter.eletiva;
  const abaAlunos = SS.getSheetByName("Alunos");
  const dados = abaAlunos.getDataRange().getValues();
  // Retorna alunos onde a coluna C (índice 2) é igual à eletiva
  const inscritos = dados.filter(r => r[2] === eletivaNome).map(r => ({
    nome: r[0],
    serie: r[1]
  }));
  return response(inscritos);
}
}

function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  if (data.action === "registrarInscricao") {
    const aba = SS.getSheetByName("Alunos");
    const dados = aba.getDataRange().getValues();
    for (let i = 1; i < dados.length; i++) {
      if (dados[i][0] === data.nome && dados[i][1] === data.serie) {
        aba.getRange(i+1, 3).setValue(data.novaEletiva);
        aba.getRange(i+1, 4).setValue(new Date());
        return response({status: "success"});
      }
    }
  }
  if (data.action === "criarEletiva") {
    SS.getSheetByName("Config_Eletivas").appendRow([
      data.nome, data.descricao, data.professor, data.vagasTotais, data.foto
    ]);
    return response({status: "success"});
  }

  if (data.action === "editarEletiva") {
    const aba = SS.getSheetByName("Config_Eletivas");
    const dados = aba.getDataRange().getValues();
    let found = false;
    for (let i = 1; i < dados.length; i++) {
      if (dados[i][0] === data.nomeAntigo) {
        aba.getRange(i+1, 1, 1, 5).setValues([[data.nome, data.descricao, data.professor, data.vagasTotais, data.foto]]);
        found = true;
        break;
      }
    }
    if (!found) return response({status: "not_found"});

    // Atualizar informações da eletiva para todos os alunos já inscritos nela
    const abaAlunos = SS.getSheetByName("Alunos");
    const dadosAlunos = abaAlunos.getDataRange().getValues();
    for (let i = 1; i < dadosAlunos.length; i++) {
      if (dadosAlunos[i][2] === data.nomeAntigo) {
        // Se o nome da eletiva mudou, atualiza o nome da eletiva do aluno
        abaAlunos.getRange(i+1, 3).setValue(data.nome);
        // (Opcional: pode-se adicionar campos extras para descrição/professor se existirem na tabela de alunos)
      }
    }
    return response({status: "success"});
  }

  if (data.action === "removerEletiva") {
    const aba = SS.getSheetByName("Config_Eletivas");
    const dados = aba.getDataRange().getValues();
    let found = false;
    for (let i = 1; i < dados.length; i++) {
      if (dados[i][0] === data.nome) {
        aba.deleteRow(i+1);
        found = true;
        break;
      }
    }
    if (!found) return response({status: "not_found"});

    // Limpar campo de eletiva dos alunos inscritos nela
    const abaAlunos = SS.getSheetByName("Alunos");
    const dadosAlunos = abaAlunos.getDataRange().getValues();
    for (let i = 1; i < dadosAlunos.length; i++) {
      if (dadosAlunos[i][2] === data.nome) {
        abaAlunos.getRange(i+1, 3).setValue("");
      }
    }
    return response({status: "success"});
  }
}

function response(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*")
    .setHeader("Access-Control-Allow-Methods", "GET,POST,OPTIONS")
    .setHeader("Access-Control-Allow-Headers", "Content-Type");
}